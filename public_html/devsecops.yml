# DevSecOps Pipeline for SurvivalTrait Website
# This workflow runs SAST, DAST, SCA, and enforces change management best practices

name: DevSecOps Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans weekly on Sundays at 2 AM
    - cron: '0 2 * * 0'

jobs:
  # Job 1: SAST - Static Application Security Testing
  sast-scan:
    name: SAST - Semgrep Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/javascript
            p/html
          generateSarif: true
      
      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif

  # Job 2: Secret Scanning
  secret-scan:
    name: Secret & Credential Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better secret detection
      
      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  # Job 3: Dependency Scanning (SCA)
  dependency-scan:
    name: SCA - Dependency Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Job 4: Code Quality & Linting
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install HTMLHint
        run: npm install -g htmlhint
      
      - name: Lint HTML files
        run: htmlhint "**/*.html"
        continue-on-error: true
      
      - name: Install stylelint
        run: npm install -g stylelint stylelint-config-standard
      
      - name: Create stylelint config
        run: |
          cat > .stylelintrc.json << 'EOF'
          {
            "extends": "stylelint-config-standard",
            "rules": {
              "selector-class-pattern": null
            }
          }
          EOF
      
      - name: Lint CSS files
        run: stylelint "**/*.css"
        continue-on-error: true

  # Job 5: Build & Test
  build-test:
    name: Build & Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate HTML
        uses: Cyb3r-Jak3/html5validator-action@v7.2.0
        with:
          root: ./
      
      - name: Check for broken links
        uses: lycheeverse/lychee-action@v1
        with:
          args: --verbose --no-progress './**/*.html' './**/*.md'
          fail: true

  # Job 6: DAST - Dynamic Application Security Testing
  dast-scan:
    name: DAST - OWASP ZAP Security Scan
    runs-on: ubuntu-latest
    # Only run DAST on main branch or scheduled runs (to avoid excessive scanning)
    if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Start local web server
        run: |
          python -m http.server 8000 &
          sleep 5
      
      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: 'http://localhost:8000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          allow_issue_writing: true
          fail_action: true

  # Job 7: Security Headers Check
  security-headers:
    name: Security Headers Validation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for security best practices
        run: |
          echo "Checking for security headers and configurations..."
          
          # Check for Content Security Policy
          if ! grep -r "Content-Security-Policy" .; then
            echo "âš ï¸  WARNING: No Content-Security-Policy found"
          fi
          
          # Check for X-Frame-Options
          if ! grep -r "X-Frame-Options" .; then
            echo "âš ï¸  WARNING: No X-Frame-Options found"
          fi
          
          # Check for hardcoded credentials
          if grep -r "password\s*=\s*['\"]" --include="*.html" --include="*.js" --include="*.php" .; then
            echo "âŒ ERROR: Potential hardcoded credentials found!"
            exit 1
          fi
          
          # Check for API keys
          if grep -rE "(api[_-]?key|apikey|api[_-]?secret)" --include="*.html" --include="*.js" .; then
            echo "âš ï¸  WARNING: Potential API keys found - verify they are not exposed"
          fi
          
          echo "âœ… Security checks completed"

  # Job 8: Compliance Check
  compliance-check:
    name: Compliance & License Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for required files
        run: |
          echo "Checking for compliance files..."
          
          # Check for privacy policy
          if [ ! -f "privacy.html" ] && [ ! -f "privacy.php" ]; then
            echo "âš ï¸  WARNING: No privacy policy found"
          else
            echo "âœ… Privacy policy exists"
          fi
          
          # Check for terms of service
          if [ ! -f "terms.html" ] && [ ! -f "terms.php" ]; then
            echo "âš ï¸  WARNING: No terms of service found"
          else
            echo "âœ… Terms of service exists"
          fi
          
          # Check for copyright notices
          if ! grep -r "Copyright" --include="*.html" .; then
            echo "âš ï¸  WARNING: No copyright notice found"
          else
            echo "âœ… Copyright notice found"
          fi

# Security Summary Job
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [sast-scan, secret-scan, dependency-scan, code-quality]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ›¡ï¸ DevSecOps Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Scans Completed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SAST (Static Application Security Testing)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Secret Scanning" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SCA (Software Composition Analysis)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code Quality Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the detailed results in the workflow tabs above." >> $GITHUB_STEP_SUMMARY
